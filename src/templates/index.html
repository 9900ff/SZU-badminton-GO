<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>深大抢场助手 - 配置</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .custom-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            padding-right: 2.5rem;
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen">
    <div class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-xl p-8 md:p-12 my-8">

        <div class="text-center mb-10">
            <h1 class="text-3xl font-bold text-gray-800">深大抢场助手</h1>
            <p class="text-gray-500 mt-2">欢迎使用！请完成抢票配置</p>
        </div>

        <form id="config-form" action="/start" method="POST" class="space-y-6">

            <!-- 隐藏的输入框，用于收集多选的时间 -->
            <input type="hidden" name="appointment" id="hidden-appointment">
            <!-- 场馆不再需要隐藏输入框，直接使用select的name -->

            <div class="bg-red-50 border-l-4 border-red-400 text-red-800 p-4 rounded-lg text-sm">
                <p class="font-bold">安全提示：</p>
                <ul class="list-disc list-inside mt-2 space-y-1">
                    <li>本项目完全开源，源程序公开可查，<strong class="font-semibold">不保存任何用户数据</strong>。</li>
                    <li>为防止在传播过程被恶意修改，<strong class="font-semibold text-blue-600">推荐选择【手动登录】</strong>。</li>
                    <li>请务必保护好自己的密码！</li>
                    <li class="mt-2">请从唯一官方地址下载本程序：<br><a href="https://github.com/9900ff/SZU-badminton-GO" target="_blank" class="text-indigo-600 hover:underline break-all">https://github.com/9900ff/SZU-badminton-GO</a></li>
                </ul>
            </div>

            <div>
                <label for="login-method" class="block text-sm font-medium text-gray-700">登录方式</label>
                <select id="login-method" name="login_method" class="custom-select mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                    <option value="auto" {% if config.get('username') or not config %}selected{% endif %}>自动登录</option>
                    <option value="manual" {% if not config.get('username') and config %}selected{% endif %}>手动登录 (推荐)</option>
                </select>
            </div>

            <div id="auto-login-fields" class="space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">学号</label>
                    <input type="text" id="username" name="username" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="请输入学号" value="{{ config.get('username', '') }}">
                </div>
                <div class="relative">
                    <label for="password" class="block text-sm font-medium text-gray-700">密码</label>
                    <input type="password" id="password" name="password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="请输入密码" value="{{ config.get('password', '') }}">
                    <button type="button" class="absolute inset-y-0 right-0 top-6 pr-3 flex items-center text-sm leading-5" onclick="togglePasswordVisibility('password', 'password-eye')">
                        <svg id="password-eye" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                    </button>
                </div>
            </div>

            <hr class="my-6 border-gray-200">

            <div>
                <label for="grabbing-mode" class="block text-sm font-medium text-gray-700">抢票模式</label>
                <select id="grabbing-mode" name="grabbing_mode" class="custom-select mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                    <option value="sticky" {% if config.get('grabbing_mode') == 'sticky' or not config.get('grabbing_mode') %}selected{% endif %}>单线程模式 (同场地优先)</option>
                    <option value="multithread" {% if config.get('grabbing_mode') == 'multithread' %}selected{% endif %}>多线程模式 (速度优先)</option>
                </select>
                <p class="mt-2 text-xs text-gray-500">
                    单线程：按时间顺序一个一个抢，抢到A后优先抢A旁边的场地。<br>
                    <strong class="text-indigo-600">多线程并发（推荐）</strong>：为每个时间段开启一个独立线程（后台浏览器）同时抢，速度最快，不保证场地相邻。
                </p>
            </div>

            <div id="multithread-warning" class="hidden bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-lg text-sm">
                <p class="font-bold">多线程模式说明：</p>
                <ul class="list-disc list-inside mt-2">
                    <li>此模式将为多个时间段**同时**抢票，速度更快，目标是至少抢中一个。</li>
                    <li>**不使用**“粘性场地”策略，不保证抢到的场地连续。</li>
                    <li>此为实验性功能，可能会不稳定。</li>
                </ul>
            </div>

            <hr class="my-6 border-gray-200">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="campus" class="block text-sm font-medium text-gray-700">校区</label>
                    <select id="campus" name="campus" class="custom-select mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option {% if config.get('campus') == '粤海校区' %}selected{% endif %}>粤海校区</option>
                        <option {% if config.get('campus') == '丽湖校区' %}selected{% endif %}>丽湖校区</option>
                    </select>
                </div>
                 <div>
                    <label for="sport" class="block text-sm font-medium text-gray-700">运动项目</label>
                    <select id="sport" name="ball" class="custom-select mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option {% if config.get('ball') == '羽毛球' %}selected{% endif %}>羽毛球</option>
                        <option disabled>其他运动项目需求不大，暂不开发</option>
                    </select>
                </div>
            </div>

            <!-- 【修改】将场馆改回下拉选择框 -->
            <div>
                <label for="venues" class="block text-sm font-medium text-gray-700">预约场馆</label>
                <select id="venues" name="venues" class="custom-select mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                    <!-- JS会动态填充 -->
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">预约时间 (可多选，按时间顺序抢)</label>
                <div id="appointment-container" class="mt-2 grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-2 border border-gray-200 rounded-md p-4">
                    <!-- JS会动态填充 -->
                </div>
            </div>

            <hr class="my-6 border-gray-200">

             <div class="relative">
                <label for="payment_password" class="block text-sm font-medium text-gray-700">支付密码 (可选)</label>
                <input type="password" id="payment_password" name="payment_password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="不填写则需稍后手动支付" value="{{ config.get('payment_password', '') }}">
                <button type="button" class="absolute inset-y-0 right-0 top-6 pr-3 flex items-center text-sm leading-5" onclick="togglePasswordVisibility('payment_password', 'payment-eye')">
                    <svg id="payment-eye" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                </button>
            </div>
            <div>
                <label for="companions_id" class="block text-sm font-medium text-gray-700">同行人 (可选)</label>
                <input type="text" id="companions_id" name="companions_id" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="多个学号用英文逗号隔开" value="{{ config.get('companions_id', '') }}">
            </div>

            <div class="pt-4">
                 <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-full shadow-lg text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">
                    保存配置并启动
                </button>
            </div>
        </form>
    </div>

    <script>
        // SVG 图标
        const eyeIcon = `<svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>`;
        const eyeOffIcon = `<svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 1.274-4.057 5.064-7 9.542-7 .847 0 1.673.126 2.462.365m3.658 3.658A9.937 9.937 0 0119.542 12c-1.274 4.057-5.064 7-9.542 7a9.953 9.953 0 01-2.502-.365M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3l18 18" /></svg>`;

        function togglePasswordVisibility(inputId, iconId) {
            const input = document.getElementById(inputId);
            const iconContainer = document.getElementById(iconId);
            if (input.type === 'password') {
                input.type = 'text';
                iconContainer.innerHTML = eyeOffIcon;
            } else {
                input.type = 'password';
                iconContainer.innerHTML = eyeIcon;
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const oldConfig = {
                // 【修改】场馆现在是单选，不再需要 split
                venues: "{{ config.get('venues', '全部') }}",
                appointments: ("{{ config.get('appointment', '19:00-20:00(可预约)') }}").split(',')
            };

            const loginMethodSelect = document.getElementById('login-method');
            const autoLoginFieldsDiv = document.getElementById('auto-login-fields');
            const grabbingModeSelect = document.getElementById('grabbing-mode');
            const multithreadWarning = document.getElementById('multithread-warning');
            const campusSelect = document.getElementById('campus');
            const sportSelect = document.getElementById('sport');
            // 【修改】获取 select 元素，而不是 div 容器
            const venuesSelect = document.getElementById('venues');
            const appointmentContainer = document.getElementById('appointment-container');
            const form = document.getElementById('config-form');

            const venueData = {
                '粤海校区': { '羽毛球': ['全部', '运动广场东馆羽毛球场', '运动广场东馆羽毛球场（教工专场）'] },
                '丽湖校区': { '羽毛球': ['全部', '至畅体育馆', '至快体育馆'] }
            };

            // 【修改】更新场馆的逻辑，现在是填充 option
            function updateVenues() {
                const selectedCampus = campusSelect.value;
                const selectedSport = sportSelect.value;
                venuesSelect.innerHTML = '';
                const venues = venueData[selectedCampus]?.[selectedSport] || [];

                venues.forEach(venue => {
                    const option = document.createElement('option');
                    option.value = venue;
                    option.textContent = venue;
                    if (venue === oldConfig.venues) {
                        option.selected = true;
                    }
                    venuesSelect.appendChild(option);
                });
            }

            function createCheckbox(container, value, text, name, checked) {
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-2 text-sm text-gray-700 cursor-pointer';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = name;
                checkbox.value = value;
                checkbox.checked = checked;
                checkbox.className = 'h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500';
                label.appendChild(checkbox);
                const span = document.createElement('span');
                span.textContent = text;
                label.appendChild(span);
                container.appendChild(label);
            }

            function generateTimeSlots() {
                appointmentContainer.innerHTML = '';
                for (let i = 8; i <= 21; i++) {
                    const start = i.toString().padStart(2, '0');
                    const end = (i + 1).toString().padStart(2, '0');
                    const timeString = `${start}:00-${end}:00(可预约)`;
                    const isChecked = oldConfig.appointments.includes(timeString);
                    createCheckbox(appointmentContainer, timeString, timeString.replace('(可预约)', ''), 'appointment_options', isChecked);
                }
            }

            function toggleLoginFields() {
                autoLoginFieldsDiv.style.display = loginMethodSelect.value === 'auto' ? 'block' : 'none';
            }

            function toggleModeWarning() {
                multithreadWarning.style.display = grabbingModeSelect.value === 'multithread' ? 'block' : 'none';
            }

            form.addEventListener('submit', function(e) {
                const checkedAppointments = Array.from(document.querySelectorAll('input[name="appointment_options"]:checked')).map(cb => cb.value);
                document.getElementById('hidden-appointment').value = checkedAppointments.join(',');

                // 【修改】不再需要处理场馆的多选
                // const checkedVenues = Array.from(document.querySelectorAll('input[name="venue_options"]:checked')).map(cb => cb.value);
                // document.getElementById('hidden-venues').value = checkedVenues.join(',');

                if (checkedAppointments.length === 0) {
                    alert('请至少选择一个预约时间！');
                    e.preventDefault(); // 阻止表单提交
                }
                // 场馆是单选下拉，无需检查是否为空
            });

            loginMethodSelect.addEventListener('change', toggleLoginFields);
            grabbingModeSelect.addEventListener('change', toggleModeWarning);
            campusSelect.addEventListener('change', updateVenues);
            sportSelect.addEventListener('change', updateVenues);

            toggleLoginFields();
            toggleModeWarning();
            generateTimeSlots();
            updateVenues();
        });
    </script>
</body>
</html>

